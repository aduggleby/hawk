@page "{monitorId:guid}/{runId:guid}"
@model Hawk.Web.Pages.Monitors.Runs.DetailsModel
@{
    ViewData["Title"] = "Run diagnostics";
    var state = string.IsNullOrWhiteSpace(Model.Run?.State) ? "completed" : Model.Run!.State;
}

@if (Model.Monitor is null || Model.Run is null)
{
    <div class="hawk-card border-[color:var(--text-primary)] border-dashed">
        <div class="text-sm">Run not found.</div>
    </div>
    return;
}

<div class="flex items-start justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl font-semibold tracking-tight mb-1">Run diagnostics</h1>
        <div class="text-sm text-[color:var(--text-secondary)]">
            <a class="underline decoration-dotted underline-offset-2 hover:no-underline"
               asp-page="/Monitors/Details"
               asp-route-id="@Model.Monitor.Id">@Model.Monitor.Name</a>
            <span class="mx-2 text-[color:var(--text-muted)]">Â·</span>
            <span>@Model.Run.StartedAt.ToLocalTime().ToString("g")</span>
        </div>
    </div>
    <a class="hawk-btn hawk-btn-ghost" asp-page="/Monitors/Details" asp-route-id="@Model.Monitor.Id">Back to monitor</a>
</div>

@section Scripts {
    <script>
        (() => {
            const state = "@state";
            if (state === "completed") return;

            const timeoutSeconds = Number("@Model.Monitor.TimeoutSeconds");
            const maxSeconds = Number.isFinite(timeoutSeconds) && timeoutSeconds > 0 ? timeoutSeconds : 300;

            const key = `hawk:run-refresh-start:@Model.Run.Id`;
            const existing = window.sessionStorage.getItem(key);
            const startedAtMs = existing ? Number(existing) : Date.now();
            if (!existing) window.sessionStorage.setItem(key, String(startedAtMs));

            const getDelayMs = (elapsedSeconds) => {
                if (maxSeconds <= 30) return 1000;
                return elapsedSeconds < 30 ? 1000 : 15000;
            };

            const elapsed = (Date.now() - startedAtMs) / 1000.0;
            if (elapsed >= maxSeconds) return;
            window.setTimeout(() => window.location.reload(), getDelayMs(elapsed));
        })();
    </script>
}

<div class="grid grid-cols-1 lg:grid-cols-12 gap-4">
    <div class="lg:col-span-4 space-y-4">
        <div class="hawk-card">
            <div class="font-semibold mb-3">Run metadata</div>
            <dl class="grid grid-cols-12 gap-y-4 text-sm">
                <dt class="col-span-4 text-[color:var(--text-secondary)] pt-1">Result</dt>
                <dd class="col-span-8">
                    @if (!string.Equals(state, "completed", StringComparison.OrdinalIgnoreCase))
                    {
                        <span class="hawk-badge hawk-badge-warning">@state.ToUpperInvariant()</span>
                    }
                    else if (Model.Run.Success)
                    {
                        <span class="hawk-badge hawk-badge-success">OK</span>
                    }
                    else
                    {
                        <span class="hawk-badge hawk-badge-danger">FAIL</span>
                    }
                </dd>
                <dt class="col-span-4 text-[color:var(--text-secondary)] pt-1">Reason</dt>
                <dd class="col-span-8 font-mono text-xs break-words py-1">@(Model.Run.Reason ?? "-")</dd>
                <dt class="col-span-4 text-[color:var(--text-secondary)] pt-1">Started</dt>
                <dd class="col-span-8 font-mono text-xs break-words py-1">@Model.Run.StartedAt.ToLocalTime().ToString("O")</dd>
                <dt class="col-span-4 text-[color:var(--text-secondary)] pt-1">Finished</dt>
                <dd class="col-span-8 font-mono text-xs break-words py-1">@Model.Run.FinishedAt.ToLocalTime().ToString("O")</dd>
                <dt class="col-span-4 text-[color:var(--text-secondary)] pt-1">Duration</dt>
                <dd class="col-span-8 font-mono text-xs break-words py-1">@Model.Run.DurationMs ms</dd>
                <dt class="col-span-4 text-[color:var(--text-secondary)] pt-1">HTTP status</dt>
                <dd class="col-span-8 font-mono text-xs break-words py-1">@(Model.Run.StatusCode?.ToString() ?? "NO_RESPONSE")</dd>
                <dt class="col-span-4 text-[color:var(--text-secondary)] pt-1">Alert</dt>
                <dd class="col-span-8 font-mono text-xs break-words py-1">@(Model.Run.AlertSent ? "sent" : (Model.Run.AlertError ?? "not sent"))</dd>
                <dt class="col-span-4 text-[color:var(--text-secondary)] pt-1">Error</dt>
                <dd class="col-span-8 font-mono text-xs break-words py-1">@(string.IsNullOrWhiteSpace(Model.Run.ErrorMessage) ? "-" : Model.Run.ErrorMessage)</dd>
            </dl>
        </div>
    </div>

    <div class="lg:col-span-8 space-y-4">
        <div class="hawk-card">
            <div class="font-semibold mb-3">Request</div>
            <div class="space-y-2 text-xs font-mono">
                <div class="break-words"><span class="text-[color:var(--text-secondary)]">URL:</span> @(Model.Run.RequestUrl ?? "-")</div>
                <div class="break-words"><span class="text-[color:var(--text-secondary)]">Method:</span> @(Model.Run.RequestMethod ?? "-")</div>
                <div class="break-words"><span class="text-[color:var(--text-secondary)]">Content-Type:</span> @(Model.Run.RequestContentType ?? "-")</div>
                <div class="break-words"><span class="text-[color:var(--text-secondary)]">Timeout:</span> @(Model.Run.RequestTimeoutMs?.ToString() ?? "-") ms</div>
                <div>
                    <div class="text-[color:var(--text-secondary)] mb-1">Headers</div>
                    <pre class="p-3 bg-[color:var(--bg-secondary)] border border-[color:var(--border-primary)] overflow-x-auto whitespace-pre-wrap break-words">@((string.IsNullOrWhiteSpace(Model.Run.RequestHeadersJson) ? "{}" : Model.Run.RequestHeadersJson))</pre>
                </div>
                <div>
                    <div class="text-[color:var(--text-secondary)] mb-1">Body snippet</div>
                    <pre class="p-3 bg-[color:var(--bg-secondary)] border border-[color:var(--border-primary)] overflow-x-auto whitespace-pre-wrap break-words">@(string.IsNullOrWhiteSpace(Model.Run.RequestBodySnippet) ? "-" : Model.Run.RequestBodySnippet)</pre>
                </div>
            </div>
        </div>

        <div class="hawk-card">
            <div class="font-semibold mb-3">Response</div>
            <div class="space-y-2 text-xs font-mono">
                <div class="break-words"><span class="text-[color:var(--text-secondary)]">Content-Type:</span> @(Model.Run.ResponseContentType ?? "-")</div>
                <div class="break-words"><span class="text-[color:var(--text-secondary)]">Content-Length:</span> @(Model.Run.ResponseContentLength?.ToString() ?? "-")</div>
                <div>
                    <div class="text-[color:var(--text-secondary)] mb-1">Headers</div>
                    <pre class="p-3 bg-[color:var(--bg-secondary)] border border-[color:var(--border-primary)] overflow-x-auto whitespace-pre-wrap break-words">@Model.FormatJson(Model.Run.ResponseHeadersJson, "{}")</pre>
                </div>
                <div>
                    <div class="text-[color:var(--text-secondary)] mb-1">Response snippet</div>
                    @{
                        var snippet = string.IsNullOrWhiteSpace(Model.Run.ResponseSnippet) ? "-" : Model.Run.ResponseSnippet!;
                        const int previewLimit = 600;
                        var hasMore = snippet.Length > previewLimit;
                        var preview = hasMore ? snippet[..previewLimit] + "..." : snippet;
                    }
                    <pre class="p-3 bg-[color:var(--bg-secondary)] border border-[color:var(--border-primary)] overflow-x-auto whitespace-pre-wrap break-words">@preview</pre>
                    @if (hasMore)
                    {
                        <details class="mt-2">
                            <summary class="cursor-pointer select-none text-[color:var(--text-secondary)]">Show full response snippet</summary>
                            <pre class="mt-2 p-3 bg-[color:var(--bg-secondary)] border border-[color:var(--border-primary)] overflow-x-auto whitespace-pre-wrap break-words">@snippet</pre>
                        </details>
                    }
                </div>
                <div>
                    <div class="text-[color:var(--text-secondary)] mb-1">Match results</div>
                    <pre class="p-3 bg-[color:var(--bg-secondary)] border border-[color:var(--border-primary)] overflow-x-auto whitespace-pre-wrap break-words">@((string.IsNullOrWhiteSpace(Model.Run.MatchResultsJson) ? "[]" : Model.Run.MatchResultsJson))</pre>
                </div>
            </div>
        </div>
    </div>
</div>
