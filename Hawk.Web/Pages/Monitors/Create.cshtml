@page
@* <summary>Create a new monitor.</summary> *@
@model Hawk.Web.Pages.Monitors.CreateModel
@{
    ViewData["Title"] = "New monitor";
    var hasPostValues =
        string.Equals(Model.Form.Method, "POST", StringComparison.OrdinalIgnoreCase) ||
        !string.IsNullOrWhiteSpace(Model.Form.Body) ||
        (!string.IsNullOrWhiteSpace(Model.Form.ContentType) &&
         !string.Equals(Model.Form.ContentType, "application/json", StringComparison.OrdinalIgnoreCase));
    var hasHeaderValues = Model.Form.HeaderNames.Any(h => !string.IsNullOrWhiteSpace(h)) ||
                          Model.Form.HeaderValues.Any(v => !string.IsNullOrWhiteSpace(v));
    var hasMatchRuleValues = Model.Form.MatchModes.Any(m => m != Hawk.Web.Services.ContentMatchMode.None) ||
                             Model.Form.MatchPatterns.Any(p => !string.IsNullOrWhiteSpace(p));
}

<div class="flex items-start justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl font-semibold tracking-tight">New monitor</h1>
        <p class="text-sm text-zinc-600">Create a new uptime or content check.</p>
    </div>
    <a class="hawk-btn hawk-btn-ghost" asp-page="/Monitors/Index">Back</a>
</div>

<form method="post" class="space-y-4">
    <div asp-validation-summary="ModelOnly" class="hawk-error-message"></div>
    <div asp-validation-summary="All" class="hawk-error-message"></div>

    <div class="hawk-card">
        <label class="hawk-label" asp-for="Form.Name"></label>
        <input class="hawk-input mt-2" asp-for="Form.Name" />
        <div class="hawk-error-message" asp-validation-for="Form.Name"></div>
    </div>

    <div class="hawk-card">
        <label class="hawk-label" asp-for="Form.Url"></label>
        <input class="hawk-input mt-2 font-mono" asp-for="Form.Url" placeholder="https://example.com/health" />
        <div class="hawk-error-message" asp-validation-for="Form.Url"></div>
    </div>

    <div class="hawk-card">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
                <label class="hawk-label" asp-for="Form.Method"></label>
                <select class="hawk-select mt-2" asp-for="Form.Method">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                </select>
                <div class="hawk-error-message" asp-validation-for="Form.Method"></div>
            </div>
            <div>
                <label class="hawk-label" asp-for="Form.IntervalSeconds"></label>
                <select class="hawk-select mt-2" asp-for="Form.IntervalSeconds">
                    @foreach (var s in Model.AllowedIntervals)
                    {
                        <option value="@s">@((s < 60) ? $"{s}s" : $"{s/60}m")</option>
                    }
                </select>
                <div class="hawk-error-message" asp-validation-for="Form.IntervalSeconds"></div>
            </div>
            <div>
                <label class="hawk-label" asp-for="Form.TimeoutSeconds"></label>
                <input class="hawk-input mt-2" asp-for="Form.TimeoutSeconds" type="number" min="1" max="300" />
                <div class="hawk-error-message" asp-validation-for="Form.TimeoutSeconds"></div>
            </div>
            <div class="flex items-end">
                <label class="inline-flex items-center gap-2 text-sm">
                    <input class="h-4 w-4" asp-for="Form.Enabled" />
                    <span class="font-medium">@Html.DisplayNameFor(m => m.Form.Enabled)</span>
                </label>
            </div>
        </div>
    </div>

    <div class="hawk-card">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
            <div>
                <label class="hawk-label" asp-for="Form.AlertAfterConsecutiveFailures"></label>
                <input class="hawk-input mt-2" asp-for="Form.AlertAfterConsecutiveFailures" type="number" min="1" max="20" />
                <div class="hawk-error-message" asp-validation-for="Form.AlertAfterConsecutiveFailures"></div>
                <div class="text-xs text-zinc-500 mt-1">Email is sent only when the failure streak reaches this number (once per incident).</div>
            </div>
            <div>
                <label class="hawk-label" asp-for="Form.AlertEmailOverride"></label>
                <input class="hawk-input mt-2 font-mono" asp-for="Form.AlertEmailOverride" placeholder="alerts@yourdomain" />
                <div class="hawk-error-message" asp-validation-for="Form.AlertEmailOverride"></div>
                <div class="text-xs text-zinc-500 mt-1">Optional. Overrides the alert recipient for this monitor.</div>
            </div>
            <div>
                <label class="hawk-label" asp-for="Form.AllowedStatusCodes"></label>
                <input class="hawk-input mt-2 font-mono" asp-for="Form.AllowedStatusCodes" placeholder="404,429" />
                <div class="hawk-error-message" asp-validation-for="Form.AllowedStatusCodes"></div>
                <div class="text-xs text-zinc-500 mt-1">Optional additional OK codes. 2xx always counts as OK.</div>
            </div>
            <div>
                <label class="hawk-label" asp-for="Form.RunRetentionDays"></label>
                <input class="hawk-input mt-2" asp-for="Form.RunRetentionDays" type="number" min="1" max="3650" placeholder="90" />
                <div class="hawk-error-message" asp-validation-for="Form.RunRetentionDays"></div>
                <div class="text-xs text-zinc-500 mt-1">Optional. Falls back to account retention, then server default (90 days).</div>
            </div>
        </div>
    </div>

    <div class="hawk-card">
        <details @if (hasPostValues) { <text>open</text> }>
            <summary class="cursor-pointer select-none">
                <div class="font-semibold inline">POST options</div>
                <div class="text-sm text-zinc-600 inline ml-2">Only used when Method=POST.</div>
            </summary>

            <div class="mt-4">
                <label class="hawk-label" asp-for="Form.ContentType"></label>
                <input class="hawk-input mt-2 font-mono" asp-for="Form.ContentType" placeholder="application/json" />
                <div class="hawk-error-message" asp-validation-for="Form.ContentType"></div>
            </div>

            <div class="mt-4">
                <label class="hawk-label" asp-for="Form.Body"></label>
                <textarea class="hawk-input mt-2 font-mono" asp-for="Form.Body" rows="6" placeholder='{
  "ping": true,
  "source": "hawk",
  "timestamp": "2026-02-11T00:00:00Z"
}'></textarea>
                <div class="hawk-error-message" asp-validation-for="Form.Body"></div>
            </div>
        </details>
    </div>

    <div class="hawk-card">
        <details @if (hasHeaderValues) { <text>open</text> }>
            <summary class="cursor-pointer select-none">
                <div class="font-semibold inline">Headers</div>
                <div class="text-sm text-zinc-600 inline ml-2">Optional request headers.</div>
            </summary>
            <div class="mt-3">
                @for (var i = 0; i < 5; i++)
                {
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-2">
                        <div class="md:col-span-4">
                            <input class="hawk-input font-mono" name="Form.HeaderNames[@i]" value="@Model.Form.HeaderNames[i]" placeholder="X-Token" />
                        </div>
                        <div class="md:col-span-8">
                            <input class="hawk-input font-mono" name="Form.HeaderValues[@i]" value="@Model.Form.HeaderValues[i]" placeholder="secret" />
                        </div>
                    </div>
                }
            </div>
        </details>
    </div>

    <div class="hawk-card">
        <details @if (hasMatchRuleValues) { <text>open</text> }>
            <summary class="cursor-pointer select-none">
                <div class="font-semibold inline">Match rules</div>
                <div class="text-sm text-zinc-600 inline ml-2">All rules must pass for the run to be marked successful.</div>
            </summary>
            <div class="mt-3">
                @for (var i = 0; i < 5; i++)
                {
                    <div class="grid grid-cols-1 md:grid-cols-12 gap-2 mb-2">
                        <div class="md:col-span-3">
                            <select class="hawk-select" name="Form.MatchModes[@i]">
                                <option value="None" selected="@(Model.Form.MatchModes[i] == Hawk.Web.Services.ContentMatchMode.None)">None</option>
                                <option value="Contains" selected="@(Model.Form.MatchModes[i] == Hawk.Web.Services.ContentMatchMode.Contains)">Contains</option>
                                <option value="Regex" selected="@(Model.Form.MatchModes[i] == Hawk.Web.Services.ContentMatchMode.Regex)">Regex</option>
                            </select>
                        </div>
                        <div class="md:col-span-9">
                            <input class="hawk-input font-mono" name="Form.MatchPatterns[@i]" value="@Model.Form.MatchPatterns[i]" placeholder="Example Domain" />
                        </div>
                    </div>
                }
            </div>
        </details>
    </div>

    <div class="flex items-center gap-2">
        <button class="hawk-btn hawk-btn-primary" type="submit">Create</button>
        <a class="hawk-btn hawk-btn-ghost" asp-page="/Monitors/Index">Cancel</a>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
